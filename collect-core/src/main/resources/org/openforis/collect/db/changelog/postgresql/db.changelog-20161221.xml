<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
 
	<changeSet id="user-groups" author="ricci" dbms="postgresql">

	    <preConditions onFail="MARK_RAN">
	    	<not>
		    	<tableExists tableName="ofc_user_group" />
	    	</not>
	    </preConditions>
	    
	    <comment>User groups</comment>
	    
	    <createTable tableName="ofc_user_group">
			<column name="id" type="INTEGER">
				<constraints nullable="false" primaryKey="true"
					primaryKeyName="ofc_user_group_pkey" />
			</column>
			<column name="name" type="VARCHAR(63)">
				<constraints nullable="false" unique="true" />
			</column>
			<column name="label" type="VARCHAR(127)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(255)" />
			<column name="created_by" type="INTEGER">
				<constraints nullable="false" 
					foreignKeyName="ofc_user_group_created_by_fkey" 
					references="ofc_user(id)" />
			</column>
			<column name="creation_date" type="DATETIME">
				<constraints nullable="false" />
			</column>
			<column name="visibility" type="CHAR(1)"
				remarks="P=Public, N=Private">
				<constraints nullable="false" />
			</column> 
		</createTable>
    	
    	<createSequence sequenceName="ofc_user_group_id_seq" />
		
		<createTable tableName="ofc_user_user_group">
			<column name="user_id" type="INTEGER">
				<constraints nullable="false" 
					foreignKeyName="ofc_user_user_group_user_fkey" 
					references="ofc_user(id)" />
			</column>
			<column name="group_id" type="INTEGER">
				<constraints nullable="false" 
					foreignKeyName="ofc_user_user_group_user_group_fkey" 
					references="ofc_user_group(id)" />
			</column>
			<column name="role" type="CHAR(1)" 
				remarks="Role in the user group: O=Owner, A=Administrator, D=Data analyzer, U=User/Operator, V=Viewer">
				<constraints nullable="false" />
			</column>
			<column name="status" type="CHAR(1)"
				remarks="P=Pending,A=Accepted,R=Rejected">
				<constraints nullable="false" />
			</column>
			<column name="request_date" type="DATETIME">
				<constraints nullable="false" />
			</column>
			<column name="member_since" type="DATETIME">
				<constraints nullable="false" />
			</column>
		</createTable>
		
		<addPrimaryKey 
			tableName="ofc_user_user_group"
			columnNames="user_id, group_id"
            constraintName="ofc_user_user_group_pkey" />
		
		<addColumn tableName="ofc_survey">
            <column name="user_group_id" type="INTEGER" />
	    </addColumn>
	</changeSet>
	
	<changeSet id="user-groups-default-values" author="ricci" dbms="postgresql">
		<sql>
    		-- Create a user group named USERNAME_default_group per each user
	    	
    		INSERT INTO collect.ofc_user_group(id, name, label, creation_date, visibility) 
	    		SELECT nextval('collect.ofc_user_group_id_seq'), 
		    		CONCAT(u.username, '_default_group'),
		    		CONCAT('Default Group of ', u.username),
		    		CURRENT_TIMESTAMP,
		    		'N'
		    	FROM collect.ofc_user u
  		 	;
    		 	
    		-- Make each user owner of his default group
	    	
    		INSERT INTO collect.ofc_user_user_group (user_id, group_id, role, status, request_date, member_since)
   		 		SELECT 
   		 			u.id, 
    		 		(SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = CONCAT(u.username, '_default_group')),
    		 		'O',
    		 		'A',
    		 		CURRENT_TIMESTAMP,
    		 		CURRENT_TIMESTAMP
	 			FROM collect.ofc_user u
  		 	;
    		 	
    		 -- Make each user with administrator role be even administrator of the admin_default_group (backwards compatibility)
    		 
    		 INSERT INTO collect.ofc_user_user_group (user_id, group_id, role, status, request_date, member_since)
   		 		SELECT 
   		 			u.id, 
    		 		(SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group'),
    		 		'A',
    		 		'A',
    		 		CURRENT_TIMESTAMP,
    		 		CURRENT_TIMESTAMP
	 			FROM collect.ofc_user u, collect.ofc_user_role ur
	 			WHERE ur.user_id = u.id 
	 				AND u.username != 'admin'
	 				AND ur.role = 'ROLE_ADMIN'
  		 	;
    		 	
    		-- Users with role ROLE_ANALYSIS will be Analyzers in admin_default_group
    		 
    		 INSERT INTO collect.ofc_user_user_group (user_id, group_id, role, status, request_date, member_since)
   		 		SELECT 
   		 			u.id, 
    		 		(SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group'),
    		 		'D',
    		 		'A',
    		 		CURRENT_TIMESTAMP,
    		 		CURRENT_TIMESTAMP
  		 			FROM collect.ofc_user u, collect.ofc_user_role ur
  		 			WHERE 
  		 				u.id NOT IN (
		 					SELECT uug.user_id FROM collect.ofc_user_user_group uug WHERE uug.group_id = (
		 						SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group')
  		 				) 
  		 				AND ur.user_id = u.id 
  		 				AND u.username != 'admin'
  		 				AND ur.role = 'ROLE_ANALYSIS'
  		 	;
    		 	
    		-- Users with role ROLE_CLEANSING will be only Analyzers in admin_default_group
    		 
    		 INSERT INTO collect.ofc_user_user_group (user_id, group_id, role, status, request_date, member_since)
   		 		SELECT 
   		 			u.id, 
    		 		(SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group'),
    		 		'D',
    		 		'A',
    		 		CURRENT_TIMESTAMP,
    		 		CURRENT_TIMESTAMP
  		 			FROM collect.ofc_user u, collect.ofc_user_role ur
  		 			WHERE 
  		 				u.id NOT IN (
		 					SELECT uug.user_id FROM collect.ofc_user_user_group uug WHERE uug.group_id = (
		 						SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group')
  		 				) 
  		 				AND ur.user_id = u.id 
  		 				AND u.username != 'admin'
  		 				AND ur.role = 'ROLE_CLEANSING'
  		 	;
    		 	
    		-- Users with role ROLE_ENTRY will be only (data entry) Operators in admin_default_group
    		 
    		 INSERT INTO collect.ofc_user_user_group (user_id, group_id, role, status, request_date, member_since)
   		 		SELECT 
   		 			u.id, 
    		 		(SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group'),
    		 		'U',
    		 		'A',
    		 		CURRENT_TIMESTAMP,
    		 		CURRENT_TIMESTAMP
  		 			FROM collect.ofc_user u, collect.ofc_user_role ur
  		 			WHERE 
  		 				u.id NOT IN (
		 					SELECT uug.user_id FROM collect.ofc_user_user_group uug WHERE uug.group_id = (
		 						SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group')
  		 				) 
  		 				AND ur.user_id = u.id 
  		 				AND u.username != 'admin'
  		 				AND ur.role = 'ROLE_ENTRY'
  		 	;
    		 	
    		 -- Users with role ROLE_VIEW will be only Viewers in admin_default_group
    		 
    		 INSERT INTO collect.ofc_user_user_group (user_id, group_id, role, status, request_date, member_since)
   		 		SELECT 
   		 			u.id, 
    		 		(SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group'),
    		 		'V',
    		 		'A',
    		 		CURRENT_TIMESTAMP,
    		 		CURRENT_TIMESTAMP
  		 			FROM collect.ofc_user u, collect.ofc_user_role ur
  		 			WHERE 
  		 				u.id NOT IN (
		 					SELECT uug.user_id FROM collect.ofc_user_user_group uug WHERE uug.group_id = (
		 						SELECT ug.id FROM collect.ofc_user_group ug WHERE ug.name = 'admin_default_group')
  		 				) 
  		 				AND ur.user_id = u.id 
  		 				AND u.username != 'admin'
  		 				AND ur.role = 'ROLE_VIEW'
  		 	;
   		 </sql>
    	
	</changeSet>
	
</databaseChangeLog>